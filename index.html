<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>スタジオ予約 | 神戸芸術センター</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA4es-RnZfGenUPgJDzDFQaIh1LBNZRxYc",
      authDomain: "studio-rental-180df.firebaseapp.com",
      projectId: "studio-rental-180df",
      storageBucket: "studio-rental-180df.firebasestorage.app",
      messagingSenderId: "485178815055",
      appId: "1:485178815055:web:f91792229f8c359cf1303a",
      measurementId: "G-EF147DP6ZB",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const studioInfo = {
      A: { color: "#ffb6c1", price: 1100 },
      B: { color: "#add8e6", price: 1100 },
      C: { color: "#90ee90", price: 1980 },
      EF: { color: "#66a3ff", price: 2310 },
      R: { color: "#fffacd", price: 2090 },
    };

    let selectedDate = null;
    let selectedSlots = [];

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "register.html";
      else document.getElementById("user-email").textContent = user.email;
    });

    let currentDate = new Date();

    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const today = new Date();

      document.getElementById("calendar-title").textContent = `${year}年${month + 1}月`;

      const weekdays = ["月","火","水","木","金","土","日"];
      const header = document.createElement("div");
      header.classList.add("weekdays");
      weekdays.forEach(w=>{
        const el=document.createElement("div");
        el.textContent=w;
        if(w==="日") el.style.color="#ff8080";
        if(w==="土") el.style.color="#7ec8ff";
        header.appendChild(el);
      });
      calendar.appendChild(header);

      const daysDiv = document.createElement("div");
      daysDiv.classList.add("days");

      let blankDays = (firstDay.getDay() + 6) % 7;
      for(let i=0;i<blankDays;i++){
        const blank=document.createElement("div");
        blank.classList.add("day","blank");
        daysDiv.appendChild(blank);
      }

      for(let d=1;d<=lastDay.getDate();d++){
        const dateObj=new Date(year,month,d);
        const dayOfWeek=dateObj.getDay();
        const el=document.createElement("div");
        el.classList.add("day");
        el.textContent=d;
        if(dayOfWeek===0) el.style.color="#ff8080";
        if(dayOfWeek===6) el.style.color="#7ec8ff";
        const isPast=dateObj<new Date(today.getFullYear(),today.getMonth(),today.getDate());
        if(!isPast){el.onclick=()=>selectDate(year,month+1,d,dayOfWeek);}else el.style.opacity="0.3";
        if(selectedDate===`${year}-${month+1}-${d}`) el.classList.add("selected");
        daysDiv.appendChild(el);
      }

      calendar.appendChild(daysDiv);
    }

    window.nextMonth=()=>{
      const now=new Date();
      const sixLater=new Date(now.getFullYear(),now.getMonth()+6);
      if(currentDate<sixLater){currentDate.setMonth(currentDate.getMonth()+1);renderCalendar();}
    };
    window.prevMonth=()=>{
      const now=new Date();
      if(currentDate.getFullYear()>now.getFullYear()||currentDate.getMonth()>now.getMonth()){
        currentDate.setMonth(currentDate.getMonth()-1);
        renderCalendar();
      }
    };

    async function selectDate(year,month,day,dayOfWeek){
      const dayNames=["日","月","火","水","木","金","土"];
      const dayName=dayNames[dayOfWeek];
      selectedDate=`${year}-${month}-${day}`;
      document.querySelectorAll(".day").forEach(d=>d.classList.remove("selected"));
      event.target.classList.add("selected");

      const grid=document.getElementById("studio-grid");
      grid.innerHTML="";

      // 時間軸（上部）
      const headerRow=document.createElement("div");
      headerRow.classList.add("time-header");
      headerRow.innerHTML="<div class='header-cell'></div>"; // 左上の空白
      for(let hour=7;hour<22;hour++){
        const cell=document.createElement("div");
        cell.classList.add("header-cell");
        cell.textContent=`${hour}:00`;
        headerRow.appendChild(cell);
      }
      grid.appendChild(headerRow);

      // 各スタジオ行
      for(const [studio,info] of Object.entries(studioInfo)){
        const row=document.createElement("div");
        row.classList.add("studio-row");

        const label=document.createElement("div");
        label.classList.add("studio-label");
        label.textContent=`${studio}`;
        label.style.backgroundColor=info.color;
        row.appendChild(label);

        for(let hour=7;hour<22;hour++){
          const slot=document.createElement("div");
          slot.classList.add("slot");
          slot.style.backgroundColor=info.color+"40";
          const slotRef=doc(db,"reservations",`${studio}_${selectedDate}_${hour}`);
          const docSnap=await getDoc(slotRef);

          if(docSnap.exists()){
            slot.textContent="✕";
            slot.classList.add("booked");
          }else{
            slot.textContent="○";
            slot.onclick=()=>toggleSlot(studio,hour,dayName,slot);
          }
          row.appendChild(slot);
        }
        grid.appendChild(row);
      }
    }

    function toggleSlot(studio,hour,dayName,el){
      const key=`${selectedDate}_${studio}_${hour}`;
      const info=studioInfo[studio];
      const label=`${selectedDate}（${dayName}）${hour}時－${hour+1}時　スタジオ${studio}　${info.price}円`;
      const existing=selectedSlots.find(s=>s.key===key);
      if(existing){
        selectedSlots=selectedSlots.filter(s=>s.key!==key);
        el.classList.remove("selected-slot");
        document.querySelectorAll(".selected-item").forEach(i=>{if(i.textContent===label)i.remove();});
      }else{
        selectedSlots.push({key,studio,hour,label});
        el.classList.add("selected-slot");
        const item=document.createElement("div");
        item.textContent=label;
        item.classList.add("selected-item");
        document.getElementById("selected-info").appendChild(item);
      }
      updateTotal();
    }

    function updateTotal(){
      const total=selectedSlots.reduce((sum,s)=>sum+studioInfo[s.studio].price,0);
      document.getElementById("total-price").textContent=`合計金額：${total.toLocaleString()}円（税込）`;
    }

    window.confirmBooking=async()=>{
      if(selectedSlots.length===0){alert("予約枠を選択してください。");return;}
      const user=auth.currentUser;
      if(!user)return alert("ログインしてください。");
      if(!confirm("選択した予約を確定しますか？\nキャンセル料規定が適用されます。"))return;
      for(const s of selectedSlots){
        await setDoc(doc(db,"reservations",`${s.studio}_${selectedDate}_${s.hour}`),{
          studio:s.studio,date:selectedDate,hour:s.hour,user:user.email,createdAt:new Date().toISOString(),
        });
      }
      alert("予約が完了しました。");
      window.location.reload();
    };

    renderCalendar();
    window.logout=async()=>{await signOut(auth);window.location.href="register.html";}
  </script>

  <style>
    body{background:#0a1a2f;color:#fff;font-family:"Hiragino Sans","Yu Gothic",sans-serif;text-align:center;margin:0;}
    header{background:#112244;padding:1rem;}
    .weekdays,.days{display:grid;grid-template-columns:repeat(7,1fr);}
    .day{padding:0.5rem;border-radius:6px;background:rgba(255,255,255,0.1);cursor:pointer;}
    .day.selected{background:#0078ff;}
    #studio-grid{margin-top:1rem;max-width:100%;overflow-x:auto;}
    .time-header,.studio-row{display:grid;grid-template-columns:80px repeat(15,1fr);gap:4px;align-items:center;}
    .header-cell{font-weight:bold;color:#7ec8ff;}
    .studio-label{height:50px;border-radius:6px;font-weight:bold;display:flex;align-items:center;justify-content:center;color:#000;}
    .slot{height:50px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;color:#000;transition:0.2s;}
    .slot.booked{background:#555;color:#ccc;cursor:not-allowed;}
    .selected-slot{outline:3px solid gold;animation:glow 1s infinite alternate;}
    @keyframes glow{from{box-shadow:0 0 10px gold;}to{box-shadow:0 0 25px white;}}
    .selected-item{background:rgba(255,255,255,0.1);margin:4px auto;padding:0.5rem 1rem;border-radius:8px;max-width:80%;text-align:center;}
    #total-price{color:#7ec8ff;font-size:1.1rem;margin-top:0.5rem;}
    footer{margin-top:2rem;color:#ccc;font-size:0.9rem;}
    .btn{background:#0078ff;color:#fff;border:none;padding:0.8rem 1.6rem;border-radius:10px;margin:1rem;cursor:pointer;}
  </style>
</head>

<body>
  <header>
    スタジオ予約システム<br>
    <small>ログイン中：<span id="user-email"></span>　
    <button onclick="logout()" style="font-size:0.8rem;">ログアウト</button></small>
  </header>

  <div id="calendar-controls">
    <button class="btn" onclick="prevMonth()">◀ 前の月</button>
    <span id="calendar-title"></span>
    <button class="btn" onclick="nextMonth()">次の月 ▶</button>
  </div>
  <div id="calendar"></div>

  <h3>スタジオ別予約状況</h3>
  <div id="studio-grid"></div>

  <div id="selected-info"></div>
  <div id="total-price"></div>
  <button class="btn" onclick="confirmBooking()">予約を確定する</button>

  <footer>
    <p>※予約確定時点でキャンセル料の規定が適用されます。</p>
    <p>予約受付：毎月1日午前9時〜6ヶ月先の月末まで。</p>
    <p>電話番号：078-241-7477　住所：神戸市中央区熊内橋通7-1-13</p>
  </footer>
</body>
</html>
