<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç¥æˆ¸èŠ¸è¡“ã‚»ãƒ³ã‚¿ãƒ¼ãƒ»ã‚¹ã‚¿ã‚¸ã‚ªWEBäºˆç´„</title>
<style>
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    background-color: #0a1a2f;
    color: white;
    margin: 0;
    overflow-x: hidden;
  }

  header {
    text-align: center;
    padding: 20px 0 10px 0;
    border-bottom: 2px solid #2e3a55;
  }
  header h1 { font-size: 26px; color: #fff; margin-bottom: 8px; }
  header .user-info { font-size: 14px; color: #fff; }
  header .logout { color: #89cfff; text-decoration: underline; cursor: pointer; }

  .instructions {
    background-color: rgba(255,255,255,0.05);
    color: #fff;
    padding: 10px 15px;
    font-size: 14px;
    text-align: left;
    border-bottom: 1px solid #2e3a55;
    max-width: 700px;
    margin: 0 auto;
    border-radius: 6px;
  }

  .calendar-controls {
    text-align: center;
    margin: 10px 0;
  }
  .monthLabel {
    font-size: 1.3em;
    color: white;
    animation: glowWhite 2s infinite alternate;
    padding: 5px 12px;
    border-radius: 8px;
    background: radial-gradient(circle at center, rgba(255,255,255,0.15), transparent 70%);
    display: inline-block;
    min-width: 140px;
    text-align: center;
  }
  @keyframes glowWhite {
    0% { text-shadow: 0 0 8px rgba(255,255,255,0.3); }
    100% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
  }

  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-auto-rows: 50px;
    gap: 2px;
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
  }

  .day-header {
    background-color: #1e3350;
    padding: 6px 0;
    font-weight: bold;
  }
  .day-header.sat { color: #73b5ff; }
  .day-header.sun { color: #ffcc66; }

  .day {
    padding: 10px 0;
    cursor: pointer;
    background-color: #12233d;
    border-radius: 6px;
    transition: 0.3s;
  }
  .day.sat { color: #73b5ff; }
  .day.sun { color: #ffcc66; }
  .day.selected {
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 0 8px rgba(255,255,255,0.4);
    border-radius: 6px;
  }

  .studio-grid {
    display: flex;
    justify-content: center;
    max-width: 700px;
    margin: 20px auto;
  }
  .studio-column {
    flex: 1;
    margin: 0 3px;
    text-align: center;
  }
  .studio-header {
    font-weight: bold;
    color: black;
    border-radius: 6px;
    margin-bottom: 4px;
    padding: 6px 0;
  }
  .studio-A { background-color: #cc7b9b; }
  .studio-B { background-color: #7aa6c7; }
  .studio-C { background-color: #7fc980; }
  .studio-EF { background-color: #7988c7; }
  .studio-R { background-color: #d9c46e; }

  .timeslot {
    background-color: rgba(255,255,255,0.2);
    border-radius: 4px;
    margin: 2px 0;
    padding: 4px 0;
    font-size: 12px;
    color: black;
    cursor: pointer;
  }
  .timeslot.booked {
    background-color: rgba(255,0,0,0.4);
    cursor: not-allowed;
  }

  .selection-summary {
    max-width: 600px;
    margin: 20px auto;
    padding: 15px;
    background-color: rgba(255,255,255,0.1);
    border-radius: 8px;
  }

  .total {
    text-align: right;
    font-size: 16px;
    color: #fff;
    font-weight: bold;
    margin-top: 8px;
  }

  .proceed-btn {
    display: block;
    margin: 25px auto;
    padding: 12px 24px;
    font-size: 1.1em;
    color: white;
    background: radial-gradient(circle at center, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
  .modal-content { background: #0a1a2f; border: 1px solid #ffffff33; border-radius: 10px; padding: 20px; width: 90%; max-width: 500px; color: white; }
  #confirmBooking:disabled { opacity: 0.4; cursor: not-allowed; }
</style>
</head>

<body>
<header>
  <h1>ç¥æˆ¸èŠ¸è¡“ã‚»ãƒ³ã‚¿ãƒ¼ãƒ»ã‚¹ã‚¿ã‚¸ã‚ªWEBäºˆç´„</h1>
  <div class="user-info">
    <span id="username">ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰</span> æ§˜ ï½œ 
    <span class="logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
  </div>
</header>

<div class="instructions">
  ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸ã³ã€å„ã‚¹ã‚¿ã‚¸ã‚ªã®åˆ©ç”¨æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚å…¨ã¦ã®é¸æŠãŒçµ‚ã‚ã£ãŸã‚‰ã€Œäºˆç´„ã¸é€²ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
</div>

<div class="calendar-controls">
  <button id="prevMonth">å‰ã®æœˆ</button>
  <span class="monthLabel" id="monthLabel">2025å¹´11æœˆ</span>
  <button id="nextMonth">æ¬¡ã®æœˆ</button>
</div>

<div class="calendar" id="calendar"></div>
<div class="studio-grid" id="studioGrid"></div>
<div class="selection-summary" id="selectionSummary">
  <div class="total">åˆè¨ˆï¼šÂ¥0ï¼ˆç¨è¾¼ï¼‰</div>
</div>
<button class="proceed-btn">äºˆç´„ã¸é€²ã‚€</button>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h2>ã”åˆ©ç”¨è¦ç´„ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼</h2>
    <p>ãƒ»30æ—¥å‰ã¾ã§ï¼šç„¡æ–™<br>ãƒ»29ã€œ8æ—¥å‰ï¼šåˆ©ç”¨æ–™ã®50ï¼…<br>ãƒ»7æ—¥å‰ä»¥é™ï¼šåˆ©ç”¨æ–™ã®100ï¼…</p>
    <label><input type="checkbox" id="agreeCheck"> è¦ç´„ã«åŒæ„ã—ã¾ã™</label><br><br>
    <input type="text" id="invoiceName" placeholder="è«‹æ±‚æ›¸å®›å" style="width:100%;margin-bottom:10px;">
    <textarea id="remarks" rows="3" placeholder="å‚™è€ƒ" style="width:100%;"></textarea><br>
    <button id="closeModal">é–‰ã˜ã‚‹</button>
    <button id="confirmBooking" disabled>äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
  </div>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.emailjs.com/sdk/3.11.0/email.min.js"></script>
<script>
(function() {
  emailjs.init("JRZlYnM7gukOpjDw9");
})();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4es-RnZfGenUPgJDzDFQaIh1LBNZRxYc",
  authDomain: "studio-rental-180df.firebaseapp.com",
  projectId: "studio-rental-180df",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const usernameSpan = document.getElementById("username");
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    usernameSpan.textContent = userDoc.exists() ? userDoc.data().name : user.email;
  } else window.location.href = "register.html";
});
window.logout = async function () {
  await signOut(auth);
  alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
  window.location.href = "register.html";
};

// ======================== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ ========================
const monthLabel = document.getElementById("monthLabel");
const calendar = document.getElementById("calendar");
const studioGrid = document.getElementById("studioGrid");
const selectionSummary = document.getElementById("selectionSummary");

const studios = ["A", "B", "C", "EF", "R"];
const studioRates = { A:1100, B:1100, C:1980, EF:2310, R:2090 };
const studioColors = { A:"#cc7b9b", B:"#7aa6c7", C:"#7fc980", EF:"#7988c7", R:"#d9c46e" };

let selections = [];
let allReservations = [];
let selectedDate = new Date();
const today = new Date();

async function fetchReservations() {
  const snapshot = await getDocs(collection(db, "reservations"));
  return snapshot.docs.map(doc => doc.data());
}

function renderCalendar() {
  calendar.innerHTML = "";
  const headers = ["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"];
  headers.forEach((d, i) => {
    const h = document.createElement("div");
    h.className = "day-header" + (i===5?" sat":i===6?" sun":"");
    h.textContent = d;
    calendar.appendChild(h);
  });
  const year = selectedDate.getFullYear(), month = selectedDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  for (let i=0; i<(firstDay.getDay()+6)%7; i++) calendar.appendChild(document.createElement("div"));
  for (let d=1; d<=lastDay.getDate(); d++) {
    const date = new Date(year, month, d);
    const div = document.createElement("div");
    div.textContent = d;
    div.className = "day";
    div.onclick = () => { selectedDate = date; renderStudios(); };
    calendar.appendChild(div);
  }
  monthLabel.textContent = `${year}å¹´${month+1}æœˆ`;
}

function renderStudios() {
  studioGrid.innerHTML = "";
  const times = Array.from({length:15},(_,i)=>`${7+i}:00ã€œ${8+i}:00`);
  studios.forEach(studio=>{
    const col = document.createElement("div");
    col.className = "studio-column";
    const head = document.createElement("div");
    head.className = `studio-header studio-${studio}`;
    head.innerHTML = `${studio}<br>Â¥${studioRates[studio]}`;
    col.appendChild(head);
    times.forEach(t=>{
      const slot = document.createElement("div");
      const dateStr = selectedDate.toDateString();
      const booked = allReservations.some(r => r.date===dateStr && r.studio===studio && r.time===t);
      if (booked) {
        slot.className="timeslot booked"; slot.innerHTML=`${t}<br>âœ•`;
      } else {
        slot.className="timeslot available";
        slot.innerHTML=`${t}<br>ã€‡`;
        slot.style.backgroundColor=studioColors[studio];
        slot.onclick=()=>toggleSelect(studio,t);
      }
      col.appendChild(slot);
    });
    studioGrid.appendChild(col);
  });
}

function toggleSelect(studio,time){
  const date=selectedDate.toDateString();
  const i=selections.findIndex(s=>s.date===date&&s.studio===studio&&s.time===time);
  if(i>=0)selections.splice(i,1);else selections.push({date,studio,time});
  renderSelections();
}

function renderSelections(){
  selectionSummary.innerHTML="";
  selections.forEach(s=>{
    const div=document.createElement("div");
    div.className="selection-item";
    div.textContent=`${s.date} ${s.studio} ${s.time}`;
    selectionSummary.appendChild(div);
  });
  const total=selections.reduce((sum,s)=>sum+studioRates[s.studio],0);
  const totalDiv=document.createElement("div");
  totalDiv.className="total";
  totalDiv.textContent=`åˆè¨ˆï¼šÂ¥${total.toLocaleString()}ï¼ˆç¨è¾¼ï¼‰`;
  selectionSummary.appendChild(totalDiv);
}

// åˆæœŸåŒ–
window.addEventListener("load", async()=>{
  allReservations = await fetchReservations();
  renderCalendar();
  renderStudios();
});

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ =====
document.querySelector(".proceed-btn").onclick = ()=>document.getElementById("confirmModal").style.display="flex";
document.getElementById("closeModal").onclick = ()=>document.getElementById("confirmModal").style.display="none";
document.getElementById("agreeCheck").onchange = e=>document.getElementById("confirmBooking").disabled=!e.target.checked;

// ===== Firestoreã¸ã®ä¿å­˜ =====
document.getElementById("confirmBooking").onclick = async ()=>{
  const user = auth.currentUser;
  if(!user){ alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚"); return; }

  const invoiceName=document.getElementById("invoiceName").value;
  const remarks=document.getElementById("remarks").value;
  for(const slot of selections){
    const id=`${slot.studio}_${slot.date}_${slot.time}`;
    await setDoc(doc(db,"reservations",id),{
      studio:slot.studio,date:slot.date,time:slot.time,
      userEmail:user.email,invoiceName,remarks,createdAt:new Date().toISOString()
    });
    // ğŸ”¸ Emailé€ä¿¡
    await emailjs.send("service_fm6jzqn","template_63qq8aj",{
      user_name:user.email,user_email:user.email,
      date:slot.date,studio:slot.studio,time:slot.time,
      price:studioRates[slot.studio],payment:"æœªæŒ‡å®š",remarks
    });
  }
  alert("äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
  location.reload();
};
</script>
</body>
</html>
