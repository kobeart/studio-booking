<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>神戸芸術センター・スタジオWEB予約</title>
<style>
  /* --- 省略しないでそのまま動くスタイル --- */
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    background-color: #0a1a2f;
    color: white;
    margin: 0;
    overflow-x: hidden;
  }
  header {
    text-align: center;
    padding: 20px 0 10px 0;
    border-bottom: 2px solid #2e3a55;
  }
  header h1 {
    font-size: 26px;
    color: #fff;
    margin-bottom: 8px;
  }
  header .user-info {
    font-size: 14px;
    color: #fff;
  }
  header .logout {
    color: #89cfff;
    text-decoration: underline;
    cursor: pointer;
  }
  .instructions {
    background-color: rgba(255,255,255,0.05);
    color: #fff;
    padding: 10px 15px;
    font-size: 14px;
    text-align: left;
    border-bottom: 1px solid #2e3a55;
    max-width: 700px;
    margin: 0 auto;
    border-radius: 6px;
  }

  .calendar-controls {
    text-align: center;
    margin: 10px 0;
  }
  .monthLabel {
    font-size: 1.3em;
    color: white;
    animation: glowWhite 2s infinite alternate;
    padding: 5px 12px;
    border-radius: 8px;
    background: radial-gradient(circle at center, rgba(255,255,255,0.15), transparent 70%);
    display: inline-block;
    min-width: 140px;
    text-align: center;
    box-sizing: border-box;
  }
  @keyframes glowWhite {
    0% { text-shadow: 0 0 8px rgba(255,255,255,0.3); }
    100% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
  }
  .calendar-controls button {
    background-color: #3e5970;
    border: none;
    padding: 5px 10px;
    margin: 0 5px;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
    font-size: 13px;
  }

  /* 固定縦6行(ヘッダ行+6週分) */
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-auto-rows: 54px;
    gap: 2px;
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
    min-height: calc(54px * 7 + 2px * 7);
  }
  .day-header {
    background-color: #1e3350;
    padding: 6px 0;
    font-weight: bold;
  }
  .day-header.sat { color: #73b5ff; }
  .day-header.sun { color: #ffcc66; }
  .day {
    padding: 6px 0;
    cursor: pointer;
    background-color: #12233d;
    border-radius: 6px;
    transition: 0.2s;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .day.sat { color: #73b5ff; }
  .day.sun { color: #ffcc66; }
  .day.selected {
    background: #12233d;
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 0 8px rgba(255,255,255,0.4), 0 0 15px rgba(255,255,255,0.12);
    animation: whiteGlow 2s infinite alternate;
    border-radius: 6px;
  }
  .day.sat.selected { color: #73b5ff !important; }
  .day.sun.selected { color: #ffcc66 !important; }
  .day:not(.sat):not(.sun).selected { color: #fff !important; }
  @keyframes whiteGlow {
    from {
      box-shadow: 0 0 6px rgba(255,255,255,0.3), 0 0 12px rgba(255,255,255,0.15);
    }
    to {
      box-shadow: 0 0 24px rgba(255,255,255,0.5), 0 0 20px rgba(255,255,255,0.3);
    }
  }

  .studio-grid {
    display: flex;
    justify-content: center;
    max-width: 700px;
    margin: 20px auto;
  }
  .studio-column {
    flex: 1;
    margin: 0 3px;
    text-align: center;
  }
  .studio-header {
    font-weight: bold;
    color: black;
    border-radius: 6px;
    margin-bottom: 6px;
    padding: 6px 0;
  }
  .studio-A { background-color: #cc7b9b; }
  .studio-B { background-color: #7aa6c7; }
  .studio-C { background-color: #7fc980; }
  .studio-EF { background-color: #7988c7; }
  .studio-R { background-color: #d9c46e; }

  .timeslot {
    border-radius: 6px;
    margin: 6px 0;
    padding: 8px 6px;
    font-size: 13px;
    color: black;
    cursor: pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:44px;
    transition: all 0.15s ease;
  }
  .timeslot.available:hover {
    background-color: rgba(255,255,255,0.12);
  }
  .timeslot.booked {
    background-color: rgba(64,64,64,0.9);
    color:#ddd;
    cursor: not-allowed;
  }
  .timeslot.selected {
    background: radial-gradient(circle at center, rgba(255,255,255,0.95), rgba(255,255,255,0.7));
    color: black;
    box-shadow: 0 0 10px rgba(255,255,255,0.8);
  }

  .selection-summary {
    max-width: 700px;
    margin: 20px auto;
    padding: 12px;
    background-color: rgba(255,255,255,0.03);
    border-radius: 8px;
    color: white;
  }
  .date-group {
    background: transparent; /* ページ全体背景と同化 */
    padding: 10px 6px;
    border-radius: 8px;
    margin-bottom:10px;
  }
  .date-title {
    color:#fff;
    font-size:14px;
    margin-bottom:8px;
    text-align:left;
  }
  .selection-item {
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-radius:8px;
    margin-bottom:8px;
    padding:10px 12px;
    color:#fff;
  }
  .selection-item .info {
    text-align:center;
    width:100%;
    font-size:20px;
    line-height:1.1;
    font-weight:700;
  }
  .selection-item .price {
    font-size:13px;
    opacity:0.9;
  }
  .selection-item button {
    background:none;
    border:none;
    color:#fff;
    text-decoration:underline;
    cursor:pointer;
    margin-left:12px;
  }

  .total {
    text-align:right;
    font-size:16px;
    color:#fff;
    font-weight:bold;
    margin-top:8px;
  }
  .proceed-btn {
    display:block;
    margin: 18px auto 40px auto;
    padding: 14px 26px;
    font-size:1.05em;
    color:white;
    background: radial-gradient(circle at center, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
    border:none;
    border-radius:8px;
    cursor:pointer;
    box-shadow:0 0 10px rgba(255,255,255,0.12);
  }

  /* modal */
  .modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
  .modal-content { background:#0a1a2f; border:1px solid #ffffff33; border-radius:10px; padding:20px; width:90%; max-width:500px; color:white; box-shadow:0 0 20px rgba(255,255,255,0.2); overflow-y:auto; max-height:85vh; }
  .modal-body { background: rgba(255,255,255,0.04); padding:10px; border-radius:6px; font-size:14px; line-height:1.5; margin-bottom:12px; }
  .modal-actions { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .modal-actions button { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
  #closeModal { background-color:#555; color:white; }
  #confirmBooking { background: radial-gradient(circle, rgba(255,255,255,0.25), rgba(255,255,255,0.05)); color:white; box-shadow:0 0 8px rgba(255,255,255,0.3); }
  #confirmBooking:disabled { opacity:0.4; cursor:not-allowed; }

  @media (max-width:700px){
    .studio-grid { max-width: 100%; padding:0 8px; }
    .selection-summary { max-width: 94%; padding:10px; }
    .monthLabel { min-width: 120px; }
    .timeslot { font-size:12px; min-height:40px; }
  }
</style>
</head>

<!-- EmailJS SDK(必ず module の外) -->
<script src="https://cdn.emailjs.com/sdk/3.11.0/email.min.js"></script>
<script>
  // EmailJS 初期化(伏字のままです)
  (function(){
    emailjs.init("伏字");
  })();

  // EmailJS 送信用のグローバル関数(Service/Template は伏字)
  window.sendBookingMail = async function(params) {
    return emailjs.send("SERVICE_伏字", "TEMPLATE_伏字", params);
  };
</script>

<body>
<header>
  <h1>神戸芸術センター・スタジオWEB予約</h1>
  <div class="user-info">
    <span id="username">(ユーザー名)</span> 様 | 
    <span class="logout" onclick="logout()">ログアウト</span>
  </div>
</header>

<div class="instructions">
  カレンダーから日付を選び、各スタジオの利用時間を選択してください。選択したご利用内容がページ下部に表示されます。全ての選択が終わったら「予約へ進む」をクリックしてください。毎月1日の午前9時に、その月から6ヶ月先の予約が可能になります。
</div>

<div class="calendar-controls">
  <button id="prevMonth">前の月</button>
  <span class="monthLabel" id="monthLabel">2025年11月</span>
  <button id="nextMonth">次の月</button>
</div>

<div class="calendar" id="calendar"></div>

<div class="studio-grid" id="studioGrid"></div>

<div class="selection-summary" id="selectionSummary">
  <!-- 選択中リストがここに入る -->
  <div class="total">合計:¥0(税込)</div>
</div>

<button class="proceed-btn">予約へ進む</button>

<!-- 予約確認モーダル -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h2>ご利用規約・キャンセルポリシー</h2>
    <div class="modal-body">
      <p>
        ・スタジオのご予約は6ヶ月先の月末まで承ります。<br>
        ・キャンセル料は以下の通りです:<br>
        　・30日前まで:無料<br>
        　・29〜8日前:利用料の50%<br>
        　・7日前以降:利用料の100%<br>
        ・ご予約確定後の日時変更もキャンセル扱いとなります。<br>
        ・お支払いは「銀行振込」または「現金」にてお願いいたします。<br>
        ・「予約を確定する」を押した時点で上記規定に同意したものとみなされます。
      </p>
    </div>

    <div class="modal-form">
      <label><input type="checkbox" id="agreeCheck"> 規約に同意します</label><br><br>

      <label>支払い方法:</label><br>
      <label><input type="radio" name="payment" value="bank" checked> 銀行振込</label>
      <label><input type="radio" name="payment" value="cash"> 現金支払い</label><br><br>

      <label>請求書宛名:</label><br>
      <input type="text" id="invoiceName" placeholder="例:神戸芸術センター 様" style="width:100%; margin-bottom:10px;"><br>

      <label>備考:</label><br>
      <textarea id="remarks" rows="3" style="width:100%;"></textarea><br><br>
    </div>

    <div class="modal-actions">
      <button id="closeModal">閉じる</button>
      <button id="confirmBooking" disabled>予約を確定する</button>
    </div>
  </div>
</div>

<!-- Firebase & main JS (module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // Firebase config (伏字のままです)
  const firebaseConfig = {
    apiKey: "伏字",
    authDomain: "伏字",
    projectId: "伏字",
    storageBucket: "伏字",
    messagingSenderId: "伏字",
    appId: "伏字"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== ログイン状態チェック =====
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      document.getElementById("username").textContent = user.displayName || user.email;
    }
  });

  window.logout = async function(){
    await signOut(auth);
    window.location.href = "login.html";
  };

  // ===== カレンダー =====
  const calendar = document.getElementById("calendar");
  const monthLabel = document.getElementById("monthLabel");
  const studioGrid = document.getElementById("studioGrid");
  const selectionSummary = document.getElementById("selectionSummary");

  const today = new Date();
  let currentMonth = today.getMonth();
  let currentYear = today.getFullYear();
  let selections = [];

  const studios = ["A","B","C","EF","R"];
  const HOURS = [9,10,11,12,13,14,15,16,17,18,19,20,21];
  const studioRates = { A:2000, B:3000, C:4000, EF:5000, R:6000 };
  const studioColors = { A:"#cc7b9b", B:"#7aa6c7", C:"#7fc980", EF:"#7988c7", R:"#d9c46e" };

  document.getElementById("prevMonth").addEventListener("click", () => {
    currentMonth--;
    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    renderCalendar();
  });
  document.getElementById("nextMonth").addEventListener("click", () => {
    currentMonth++;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    renderCalendar();
  });

  function renderCalendar(){
    calendar.innerHTML = "";
    const monthNames = ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];
    monthLabel.textContent = `${currentYear}年${monthNames[currentMonth]}`;

    const dayNames = ["日","月","火","水","木","金","土"];
    dayNames.forEach((d, i) => {
      const hd = document.createElement("div");
      hd.className = "day-header";
      if (i === 6) hd.classList.add("sat");
      if (i === 0) hd.classList.add("sun");
      hd.textContent = d;
      calendar.appendChild(hd);
    });

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
    const totalCells = 42;

    for (let i = 0; i < totalCells; i++){
      const dayDiv = document.createElement("div");
      dayDiv.className = "day";
      const dayNum = i - firstDay + 1;
      if (dayNum > 0 && dayNum <= daysInMonth){
        dayDiv.textContent = dayNum;
        const date = new Date(currentYear, currentMonth, dayNum);
        const dow = date.getDay();
        if (dow === 6) dayDiv.classList.add("sat");
        if (dow === 0) dayDiv.classList.add("sun");

        dayDiv.addEventListener("click", () => {
          document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
          dayDiv.classList.add("selected");
          selectedDate = date;
          renderStudios();
        });
      }
      calendar.appendChild(dayDiv);
    }
  }

  // ===== 日付・スタジオの描画 =====
  let selectedDate = new Date(today);
  function renderStudios(){
    studioGrid.innerHTML = "";
    const times = HOURS.map(h => `${h}:00〜${h+1}:00`);
    studios.forEach(studio => {
      const col = document.createElement("div");
      col.className = "studio-column";
      const head = document.createElement("div");
      head.className = `studio-header studio-${studio}`;
      head.innerHTML = `${studio}<br>¥${studioRates[studio]}`;
      col.appendChild(head);

      // For each time slot we need to check Firestore whether it's reserved for selectedDate
      times.forEach((timeStr, idx) => {
        const hour = HOURS[idx];
        const slot = document.createElement("div");
        slot.className = "timeslot";
        slot.dataset.studio = studio;
        slot.dataset.hour = hour;
        // initial content
        slot.innerHTML = `<div style="text-align:center;">${timeStr}<br><span style="opacity:0.9">〇</span></div>`;
        slot.style.backgroundColor = studioColors[studio] + "44"; // より明るく
        // click behavior
        slot.addEventListener("click", () => {
          // if already booked, do nothing
          if (slot.classList.contains("booked")) return;
          // toggle selection
          const dateStr = formatDate(selectedDate);
          const existsIndex = selections.findIndex(s => s.date === dateStr && s.studio === studio && s.hour === hour);
          if (existsIndex >= 0) {
            selections.splice(existsIndex,1);
            slot.classList.remove("selected");
          } else {
            selections.push({ date: dateStr, time: timeStr, studio, hour });
            slot.classList.add("selected");
          }
          renderSelections();
        });

        col.appendChild(slot);
      });

      studioGrid.appendChild(col);
    });

    // After drawing all slots, update booked marks (async)
    markBookedSlotsForSelectedDate();
  }

  // mark bookedSlots by querying Firestore for selectedDate
  async function markBookedSlotsForSelectedDate(){
    try {
      // early exit if no selectedDate
      if (!selectedDate) return;
      const dateStr = formatDate(selectedDate);
      // Iterate DOM slots and check Firestore per slot (simple approach)
      const slotEls = studioGrid.querySelectorAll(".studio-column");
      for (let ci=0; ci<slotEls.length; ci++){
        const col = slotEls[ci];
        const studio = studios[ci];
        const slots = col.querySelectorAll(".timeslot");
        for (let si=0; si<slots.length; si++){
          const hour = HOURS[si];
          const id = `${studio}_${dateStr}_${hour}`;
          try {
            const snap = await getDoc(doc(db, "reservations", id));
            const slotEl = slots[si];
            if (snap.exists()) {
              slotEl.classList.add("booked");
              slotEl.innerHTML = `<div style="text-align:center;">${HOURS[si]}:00〜${HOURS[si]+1}:00<br><span style="opacity:0.9">✕</span></div>`;
              slotEl.style.backgroundColor = "rgba(64,64,64,0.9)";
            } else {
              // if selected, show selected style
              const dateStrSel = formatDate(selectedDate);
              const isSelected = selections.some(s => s.date===dateStrSel && s.studio===studio && s.hour===hour);
              const slotEl = slots[si];
              if (isSelected) slotEl.classList.add("selected");
              else slotEl.classList.remove("selected");
              // ensure available mark
              if (!slotEl.classList.contains("booked")) {
                slotEl.innerHTML = `<div style="text-align:center;">${HOURS[si]}:00〜${HOURS[si]+1}:00<br><span style="opacity:0.9">〇</span></div>`;
                slotEl.style.backgroundColor = studioColors[studio] + "44";
              }
            }
          } catch(e) {
            console.error("slot check error", e);
          }
        }
      }
    } catch(e) {
      console.error("markBookedSlotsForSelectedDate error", e);
    }
  }

  function formatDate(dt){
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
  }

  // ===== 選択リストの描画 =====
  function renderSelections(){
    selectionSummary.innerHTML = ""; // clear

    // show heading if selections exist
    if (selections.length > 0){
      const heading = document.createElement("h2");
      heading.id = "selectionHeading";
      heading.textContent = "選択中";
      heading.style.textAlign = "left";
      heading.style.color = "white";
      heading.style.margin = "0 0 12px 0";
      selectionSummary.appendChild(heading);
    }

    // group by date
    const grouped = {};
    selections.forEach(s => {
      if (!grouped[s.date]) grouped[s.date] = [];
      grouped[s.date].push(s);
    });

    Object.keys(grouped).sort().forEach(dateKey => {
      const dateGroup = document.createElement("div");
      dateGroup.className = "date-group";
      const title = document.createElement("div");
      const d = new Date(dateKey);
      const jp = ["日","月","火","水","木","金","土"][d.getDay()];
      title.className = "date-title";
      title.textContent = `${dateKey}(${jp})`;
      dateGroup.appendChild(title);

      grouped[dateKey].forEach(sel => {
        const div = document.createElement("div");
        div.className = "selection-item";
        div.style.backgroundColor = studioColors[sel.studio];
        // info
        const info = document.createElement("div");
        info.className = "info";
        info.style.color = "#fff";
        info.innerHTML = `${sel.time}　スタジオ${sel.studio}`;
        div.appendChild(info);
        // price on the right (small)
        const price = document.createElement("div");
        price.className = "price";
        price.style.marginLeft = "10px";
        price.textContent = `¥${studioRates[sel.studio].toLocaleString()}`;
        div.appendChild(price);
        // delete link
        const btn = document.createElement("button");
        btn.textContent = "削除";
        btn.onclick = () => {
          removeSelection(sel.date, sel.studio, sel.hour);
        };
        div.appendChild(btn);

        dateGroup.appendChild(div);
      });

      selectionSummary.appendChild(dateGroup);
    });

    const total = selections.reduce((s,x)=> s + Number(studioRates[x.studio]), 0);
    const totalDiv = document.createElement("div");
    totalDiv.className = "total";
    totalDiv.textContent = `合計:¥${total.toLocaleString()}(税込)`;
    selectionSummary.appendChild(totalDiv);
  }

  function removeSelection(date, studio, hour){
    selections = selections.filter(s => !(s.date===date && s.studio===studio && s.hour===hour));
    renderSelections();
    // 対応するスロットのselectedクラスを削除
    const slotEl = studioGrid.querySelector(`.timeslot[data-studio="${studio}"][data-hour="${hour}"]`);
    if (slotEl) {
      slotEl.classList.remove("selected");
    }
  }

  // open modal
  document.querySelector(".proceed-btn").addEventListener("click", () => {
    if (selections.length === 0) { alert("予約枠を選択してください。"); return; }
    document.getElementById("confirmModal").style.display = "flex";
  });
  // close modal
  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("confirmModal").style.display = "none";
  });
  // agree check
  document.getElementById("agreeCheck").addEventListener("change", (e) => {
    document.getElementById("confirmBooking").disabled = !e.target.checked;
  });

  // ===== 予約確定処理(Firestore へ保存 → EmailJSでまとめメール送信) =====
  document.getElementById("confirmBooking").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) { alert("ログインが必要です。"); return; }

    const payment = document.querySelector("input[name='payment']:checked").value;
    const invoiceName = document.getElementById("invoiceName").value.trim();
    const remarks = document.getElementById("remarks").value.trim();

    if (selections.length === 0) { alert("予約枠が選択されていません。"); return; }

    // attempt to write each selection to Firestore (check conflicts)
    const successes = [];
    const failures = [];

    for (const s of selections) {
      const id = `${s.studio}_${s.date}_${s.hour}`;
      try {
        const snap = await getDoc(doc(db, "reservations", id));
        if (snap.exists()) {
          failures.push({ s, reason: "既に予約済み" });
          continue;
        }
        // write reservation
        await setDoc(doc(db, "reservations", id), {
          studio: s.studio,
          date: s.date,
          hour: s.hour,
          timeLabel: s.time,
          userEmail: user.email,
          invoiceName,
          remarks,
          payment,
          createdAt: new Date().toISOString()
        });
        successes.push(s);
      } catch (e) {
        console.error("書き込みエラー", e);
        failures.push({ s, reason: "書き込みエラー" });
      }
    }

    if (successes.length === 0) {
      alert("選択した枠のすべてが確保できませんでした。");
      return;
    }

    // build reservation_list for email (summary)
    const reservation_list = successes.map(s => {
      const d = new Date(s.date);
      const jp = ["日","月","火","水","木","金","土"][d.getDay()];
      return `${s.date}(${jp}) ${s.time} スタジオ${s.studio} ¥${studioRates[s.studio]}`;
    }).join("\n");

    // prepare email params
    const emailParams = {
      user_name: user.displayName || user.email,
      user_email: user.email,
      reservation_list,
      payment,
      invoice_name: invoiceName,
      remarks
    };

    try {
      // send email via EmailJS (global wrapper)
      await window.sendBookingMail(emailParams);

      alert("予約が完了しました。確認メールを送信しました。");

      // close modal and refresh UI
      document.getElementById("confirmModal").style.display = "none";
      // reset selections to only keep failures (if wanted) - here we clear successes
      selections = failures.map(f => ({ date: f.s.date, time: f.s.time, studio: f.s.studio, hour: f.s.hour }));
      renderSelections();
      renderStudios();
    } catch (e) {
      console.error("Email送信エラー", e);
      alert("予約は保存されましたが、確認メールの送信に失敗しました。");
    }
  });

  // initial render
  window.addEventListener("load", () => {
    selectedDate = new Date(today);
    renderCalendar();
    renderStudios();
    renderSelections();
  });

  // helper: format & safe
  // (already defined above as formatDate)
</script>
</body>
</html>
