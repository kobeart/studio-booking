<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>スタジオ予約 | 神戸芸術センター</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA4es-RnZfGenUPgJDzDFQaIh1LBNZRxYc",
      authDomain: "studio-rental-180df.firebaseapp.com",
      projectId: "studio-rental-180df",
      storageBucket: "studio-rental-180df.firebasestorage.app",
      messagingSenderId: "485178815055",
      appId: "1:485178815055:web:f91792229f8c359cf1303a",
      measurementId: "G-EF147DP6ZB",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let selectedStudio = null;
    let selectedDate = null;
    let selectedSlots = [];

    const studioColors = {
      A: "#ffb6c1",
      B: "#add8e6",
      C: "#90ee90",
      EF: "#66a3ff",
      R: "#fffacd",
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("ログインしてください。");
        window.location.href = "register.html";
      } else {
        document.getElementById("user-email").textContent = user.email;
      }
    });

    window.selectStudio = (studio) => {
      selectedStudio = studio;
      selectedSlots = [];
      document.querySelectorAll(".studio-btn").forEach(btn => btn.classList.remove("active"));
      const activeBtn = document.getElementById(`studio-${studio}`);
      activeBtn.classList.add("active");
      activeBtn.scrollIntoView({ behavior: "smooth", block: "center" });
      renderCalendar();
      document.getElementById("time-slots").innerHTML = "";
    };

    let currentDate = new Date();

    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      document.getElementById("calendar-title").textContent = `${year}年${month + 1}月`;

      const weekdays = ["日","月","火","水","木","金","土"];
      const headerRow = document.createElement("div");
      headerRow.classList.add("weekdays");
      weekdays.forEach((w, i) => {
        const wd = document.createElement("div");
        wd.textContent = w;
        if (i === 0) wd.style.color = "#ff7b7b";
        if (i === 6) wd.style.color = "#7ec8ff";
        headerRow.appendChild(wd);
      });
      calendar.appendChild(headerRow);

      const daysDiv = document.createElement("div");
      daysDiv.classList.add("days");

      for (let i = 0; i < firstDay.getDay(); i++) {
        const blank = document.createElement("div");
        blank.classList.add("day", "blank");
        daysDiv.appendChild(blank);
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dayEl = document.createElement("div");
        dayEl.classList.add("day");
        dayEl.textContent = d;
        dayEl.onclick = () => selectDate(year, month + 1, d);
        if (selectedDate === `${year}-${month + 1}-${d}`) {
          dayEl.classList.add("selected");
        }
        daysDiv.appendChild(dayEl);
      }

      calendar.appendChild(daysDiv);
    }

    window.nextMonth = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    };

    window.prevMonth = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    };

    async function selectDate(year, month, day) {
      if (!selectedStudio) {
        alert("スタジオを選択してください。");
        return;
      }

      selectedDate = `${year}-${month}-${day}`;
      document.querySelectorAll(".day").forEach((d) => d.classList.remove("selected"));
      event.target.classList.add("selected");

      const timeSlotsDiv = document.getElementById("time-slots");
      timeSlotsDiv.innerHTML = `<h3>${selectedDate} の予約状況 (${selectedStudio})</h3><div class='slots-grid'></div>`;
      const grid = timeSlotsDiv.querySelector(".slots-grid");

      for (let hour = 7; hour < 22; hour++) {
        const slotEl = document.createElement("div");
        slotEl.classList.add("slot");
        slotEl.style.backgroundColor = studioColors[selectedStudio];
        const time = `${hour}:00 - ${hour + 1}:00`;
        const slotId = `${hour}`;
        const docRef = doc(db, "reservations", `${selectedStudio}_${selectedDate}_${slotId}`);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          slotEl.textContent = `${time} ✕`;
          slotEl.classList.add("booked");
        } else {
          slotEl.textContent = `${time} ○`;
          slotEl.onclick = () => toggleSlot(slotId, time, slotEl);
        }
        grid.appendChild(slotEl);
      }
    }

    function toggleSlot(slotId, time, el) {
      if (selectedSlots.includes(slotId)) {
        selectedSlots = selectedSlots.filter((s) => s !== slotId);
        el.classList.remove("selected-slot");
      } else {
        selectedSlots.push(slotId);
        el.classList.add("selected-slot");
      }
    }

    window.confirmBooking = async () => {
      if (!selectedStudio || !selectedDate || selectedSlots.length === 0) {
        alert("スタジオ・日付・時間を選択してください。");
        return;
      }

      const user = auth.currentUser;
      if (!user) return alert("ログインが必要です。");

      const confirmMsg = `以下の内容で予約を確定します。\n\nスタジオ: ${selectedStudio}\n日付: ${selectedDate}\n時間: ${selectedSlots.join(", ")}時\n\nキャンセル料規定が適用されます。`;
      if (!confirm(confirmMsg)) return;

      for (const slotId of selectedSlots) {
        await setDoc(doc(db, "reservations", `${selectedStudio}_${selectedDate}_${slotId}`), {
          studio: selectedStudio,
          date: selectedDate,
          hour: slotId,
          user: user.email,
          createdAt: new Date().toISOString(),
        });
      }

      alert("予約が完了しました。");
      window.location.reload();
    };

    renderCalendar();

    window.logout = async () => {
      await signOut(auth);
      window.location.href = "register.html";
    };
  </script>

  <style>
    body {
      background-color: #0a1a2f;
      color: #fff;
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      margin: 0;
      text-align: center;
      padding-bottom: 3rem;
    }
    header {
      background-color: #112244;
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .studio-btns {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1rem;
      gap: 0.5rem;
    }
    .studio-btn {
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      color: #000;
      transition: transform 0.2s;
    }
    .studio-btn.active {
      color: #fff;
      animation: pulse 1.5s infinite;
      transform: scale(1.05);
      border: 3px solid #fff;
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 10px #fff; }
      50% { box-shadow: 0 0 20px #7ec8ff; }
    }
    #calendar {
      margin: 1rem auto;
      max-width: 600px;
      background: rgba(255,255,255,0.05);
      padding: 1rem;
      border-radius: 10px;
    }
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .day {
      padding: 0.5rem 0;
      border-radius: 6px;
      cursor: pointer;
      background: rgba(255,255,255,0.1);
    }
    .day.selected {
      background: #0078ff;
    }
    .slots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 6px;
      margin-top: 1rem;
    }
    .slot {
      border-radius: 6px;
      padding: 0.5rem;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    .slot.booked {
      background: #777 !important;
      color: #eee;
      cursor: not-allowed;
    }
    .selected-slot {
      outline: 3px solid #fff;
    }
    footer {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 2rem;
    }
    .btn {
      background: #0078ff;
      color: #fff;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 10px;
      margin-top: 1rem;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header>
    スタジオ予約システム
    <div style="font-size:0.8rem; margin-top:0.5rem;">ログイン中：<span id="user-email"></span>　
      <button onclick="logout()" style="font-size:0.8rem;">ログアウト</button>
    </div>
  </header>

  <h2>スタジオを選択してください</h2>
  <div class="studio-btns">
    <button id="studio-A" class="studio-btn" style="background:#ffb6c1" onclick="selectStudio('A')">スタジオA<br>¥1,100</button>
    <button id="studio-B" class="studio-btn" style="background:#add8e6" onclick="selectStudio('B')">スタジオB<br>¥1,100</button>
    <button id="studio-C" class="studio-btn" style="background:#90ee90" onclick="selectStudio('C')">スタジオC<br>¥1,980</button>
    <button id="studio-EF" class="studio-btn" style="background:#66a3ff" onclick="selectStudio('EF')">スタジオEF<br>¥2,310</button>
    <button id="studio-R" class="studio-btn" style="background:#fffacd" onclick="selectStudio('R')">スタジオR<br>¥2,090</button>
  </div>

  <div id="calendar-controls">
    <button class="btn" onclick="prevMonth()">◀ 前の月</button>
    <span id="calendar-title" style="margin:0 1rem;"></span>
    <button class="btn" onclick="nextMonth()">次の月 ▶</button>
  </div>

  <div id="calendar"></div>
  <div id="time-slots"></div>

  <button class="btn" onclick="confirmBooking()">予約を確定する</button>

  <footer>
    <p>※予約確定時点でキャンセル料の規定が適用されます。</p>
    <p>予約受付：毎月1日午前9時〜6ヶ月先の月末まで。</p>
    <p>電話番号：078-241-7477　住所：神戸市中央区熊内橋通7-1-13</p>
  </footer>
</body>
</html>
