<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>神戸芸術センター・スタジオWEB予約</title>
<style>
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    background-color: #0a1a2f;
    color: white;
    margin: 0;
    overflow-x: hidden;
  }

  header {
    text-align: center;
    padding: 20px 0 10px 0;
    border-bottom: 2px solid #2e3a55;
  }
  header h1 { font-size: 26px; color: #fff; margin-bottom: 8px; }
  header .user-info { font-size: 14px; color: #fff; }
  header .logout { color: #89cfff; text-decoration: underline; cursor: pointer; }

  .instructions {
    background-color: rgba(255,255,255,0.05);
    color: #fff;
    padding: 10px 15px;
    font-size: 14px;
    text-align: left;
    border-bottom: 1px solid #2e3a55;
    max-width: 700px;
    margin: 0 auto;
    border-radius: 6px;
  }

  .calendar-controls {
    text-align: center;
    margin: 10px 0;
  }
  .monthLabel {
    font-size: 1.3em;
    color: white;
    animation: glowWhite 2s infinite alternate;
    padding: 5px 12px;
    border-radius: 8px;
    background: radial-gradient(circle at center, rgba(255,255,255,0.15), transparent 70%);
    display: inline-block;
    min-width: 140px;
    text-align: center;
  }
  @keyframes glowWhite {
    0% { text-shadow: 0 0 8px rgba(255,255,255,0.3); }
    100% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
  }

  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-auto-rows: 50px;
    gap: 2px;
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
  }

  .day-header {
    background-color: #1e3350;
    padding: 6px 0;
    font-weight: bold;
  }
  .day-header.sat { color: #73b5ff; }
  .day-header.sun { color: #ffcc66; }

  .day {
    padding: 10px 0;
    cursor: pointer;
    background-color: #12233d;
    border-radius: 6px;
    transition: 0.3s;
  }
  .day.sat { color: #73b5ff; }
  .day.sun { color: #ffcc66; }
  .day.selected {
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 0 8px rgba(255,255,255,0.4);
    border-radius: 6px;
  }

  .studio-grid {
    display: flex;
    justify-content: center;
    max-width: 700px;
    margin: 20px auto;
  }
  .studio-column {
    flex: 1;
    margin: 0 3px;
    text-align: center;
  }
  .studio-header {
    font-weight: bold;
    color: black;
    border-radius: 6px;
    margin-bottom: 4px;
    padding: 6px 0;
  }
  .studio-A { background-color: #cc7b9b; }
  .studio-B { background-color: #7aa6c7; }
  .studio-C { background-color: #7fc980; }
  .studio-EF { background-color: #7988c7; }
  .studio-R { background-color: #d9c46e; }

  .timeslot {
    background-color: rgba(255,255,255,0.2);
    border-radius: 4px;
    margin: 2px 0;
    padding: 4px 0;
    font-size: 12px;
    color: black;
    cursor: pointer;
  }
  .timeslot.booked {
    background-color: rgba(255,0,0,0.4);
    cursor: not-allowed;
  }

  .timeslot.selected {
  background: radial-gradient(circle at center, rgba(255,255,255,0.9), rgba(255,255,255,0.6));
  color: black;
  box-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 15px rgba(255,255,255,0.5);
  animation: slotGlow 1.8s infinite alternate;
}

/* 光のアニメーション */
@keyframes slotGlow {
  from {
    box-shadow: 0 0 6px rgba(255,255,255,0.5), 0 0 10px rgba(255,255,255,0.3);
  }
  to {
    box-shadow: 0 0 15px rgba(255,255,255,0.9), 0 0 25px rgba(255,255,255,0.6);
  }
}
  
  .selection-summary {
    max-width: 600px;
    margin: 20px auto;
    padding: 15px;
    background-color: rgba(255,255,255,0.1);
    border-radius: 8px;
  }

  .total {
    text-align: right;
    font-size: 16px;
    color: #fff;
    font-weight: bold;
    margin-top: 8px;
  }

  .proceed-btn {
    display: block;
    margin: 25px auto;
    padding: 12px 24px;
    font-size: 1.1em;
    color: white;
    background: radial-gradient(circle at center, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  /* モーダル */
  .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
  .modal-content { background: #0a1a2f; border: 1px solid #ffffff33; border-radius: 10px; padding: 20px; width: 90%; max-width: 500px; color: white; }
  #confirmBooking:disabled { opacity: 0.4; cursor: not-allowed; }
</style>
</head>

<body>
<header>
  <h1>神戸芸術センター・スタジオWEB予約</h1>
  <div class="user-info">
    <span id="username">（ユーザー名）</span> 様 ｜ 
    <span class="logout" onclick="logout()">ログアウト</span>
  </div>
</header>

<div class="instructions">
  カレンダーから日付を選び、各スタジオの利用時間を選択してください。全ての選択が終わったら「予約へ進む」をクリックしてください。
</div>

<div class="calendar-controls">
  <button id="prevMonth">前の月</button>
  <span class="monthLabel" id="monthLabel">2025年11月</span>
  <button id="nextMonth">次の月</button>
</div>

<div class="calendar" id="calendar"></div>
<div class="studio-grid" id="studioGrid"></div>
<div class="selection-summary" id="selectionSummary">
  <div class="total">合計：¥0（税込）</div>
</div>
<button class="proceed-btn">予約へ進む</button>

<!-- モーダル -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h2>ご利用規約・キャンセルポリシー</h2>
    <p>・30日前まで：無料<br>・29〜8日前：利用料の50％<br>・7日前以降：利用料の100％</p>
    <label><input type="checkbox" id="agreeCheck"> 規約に同意します</label><br><br>
    <input type="text" id="invoiceName" placeholder="請求書宛名" style="width:100%;margin-bottom:10px;">
    <textarea id="remarks" rows="3" placeholder="備考" style="width:100%;"></textarea><br>
    <button id="closeModal">閉じる</button>
    <button id="confirmBooking" disabled>予約を確定する</button>
  </div>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.emailjs.com/sdk/3.11.0/email.min.js"></script>
<script>
(function() {
  emailjs.init("JRZlYnM7gukOpjDw9");
})();
</script>

<script type="module">

/* ========== Firebase 設定 ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4es-RnZfGenUPgJDzDFQaIh1LBNZRxYc",
  authDomain: "studio-rental-180df.firebaseapp.com",
  projectId: "studio-rental-180df",
  storageBucket: "studio-rental-180df.firebasestorage.app",
  messagingSenderId: "485178815055",
  appId: "1:485178815055:web:f91792229f8c359cf1303a",
  measurementId: "G-EF147DP6ZB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========== ログインユーザー表示 ========== */
const usernameSpan = document.getElementById("username");
onAuthStateChanged(auth, async (user) => {
  if (user) {
    try {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      usernameSpan.textContent = userDoc.exists() ? userDoc.data().name : user.email;
    } catch {
      usernameSpan.textContent = user.email;
    }
  } else {
    window.location.href = "register.html";
  }
});

window.logout = async () => {
  await signOut(auth);
  alert("ログアウトしました");
  window.location.href = "register.html";
};

/* ========== カレンダーと予約システム ========== */
const calendar = document.getElementById("calendar");
const monthLabel = document.getElementById("monthLabel");
const studioGrid = document.getElementById("studioGrid");
const selectionSummary = document.getElementById("selectionSummary");
const studios = ["A", "B", "C", "EF", "R"];
const studioRates = { A:1100, B:1100, C:1980, EF:2310, R:2090 };
const studioColors = { A:"#cc7b9b", B:"#7aa6c7", C:"#7fc980", EF:"#7988c7", R:"#d9c46e" };
let selections = [];
let selectedDate = new Date();

async function getReservations(dateStr) {
  const snapshot = await getDocs(collection(db, "reservations"));
  const reserved = [];
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.date === dateStr) reserved.push(data);
  });
  return reserved;
}

function renderCalendar(year = selectedDate.getFullYear(), month = selectedDate.getMonth()) {
  calendar.innerHTML = "";
  const headers = ["月","火","水","木","金","土","日"];
  headers.forEach((d,i)=>{
    const h=document.createElement("div");
    h.className="day-header" + (i===5?" sat":i===6?" sun":"");
    h.textContent=d;
    calendar.appendChild(h);
  });

  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0);
  const start = (first.getDay()+6)%7;
  monthLabel.textContent = `${year}年${month+1}月`;

  for(let i=0;i<start;i++)calendar.appendChild(document.createElement("div"));

  for(let d=1; d<=last.getDate(); d++){
    const date = new Date(year,month,d);
    const div=document.createElement("div");
    div.textContent=d;
    div.className="day";
    if(date.getDay()===6)div.classList.add("sat");
    if(date.getDay()===0)div.classList.add("sun");
    if(date < new Date().setHours(0,0,0,0)) {
      div.style.opacity="0.3";
      div.style.pointerEvents="none";
    } else {
      div.addEventListener("click",()=>{
        selectedDate=date;
        renderCalendar(year,month);
        renderStudios();
      });
    }
    if(date.toDateString()===selectedDate.toDateString()) div.classList.add("selected");
    calendar.appendChild(div);
  }
}

/* ========== スタジオ枠描画 ========== */
async function renderStudios(){
  studioGrid.innerHTML="";
  const dateStr = selectedDate.toDateString();
  const reserved = await getReservations(dateStr);
  const times = Array.from({length:15},(_,i)=>`${7+i}:00〜${8+i}:00`);

  studios.forEach(studio=>{
    const col=document.createElement("div");
    col.className="studio-column";
    const head=document.createElement("div");
    head.className=`studio-header studio-${studio}`;
    head.innerHTML=`${studio}<br>¥${studioRates[studio]}`;
    col.appendChild(head);

    times.forEach(time=>{
      const slot=document.createElement("div");
      slot.className="timeslot";
const booked = reserved.find(r => r.studio === studio && r.time === time);
if (booked) {
  slot.innerHTML = `${time}<br>✕`;
  slot.classList.add("booked");
  slot.style.backgroundColor = "#333";  // 暗いグレーに
  slot.style.color = "white";            // 白文字に
  slot.style.height = "auto";            // 他の枠と高さを揃える
  slot.style.padding = "4px 0";          // 上下中央に見せる
} else {
  slot.innerHTML = `${time}<br>〇`;
  slot.classList.add("available");
  slot.style.backgroundColor = studioColors[studio];
  slot.onclick = () => toggleSelect(studio, time);
}
      if(selections.find(s=>s.date===dateStr&&s.studio===studio&&s.time===time)) slot.classList.add("selected");
      col.appendChild(slot);
    });
    studioGrid.appendChild(col);
  });
}

/* ========== 選択管理 ========== */
function toggleSelect(studio,time){
  const dateStr=selectedDate.toDateString();
  const key={date:dateStr,studio,time};
  const idx=selections.findIndex(s=>s.date===key.date&&s.studio===key.studio&&s.time===key.time);
  if(idx>=0) selections.splice(idx,1);
  else selections.push(key);
  renderSelections();
  renderStudios();
}

function renderSelections() {
  selectionSummary.innerHTML = "";

  // ▼ 「選択中」見出しを動的に表示
  let heading = document.getElementById("selectionHeading");
  if (!heading) {
    heading = document.createElement("h2");
    heading.id = "selectionHeading";
    heading.textContent = "選択中";
    heading.style.textAlign = "center";
    heading.style.color = "white";
    heading.style.marginTop = "30px";
    heading.style.display = "none";
    selectionSummary.parentNode.insertBefore(heading, selectionSummary);
  }
  heading.style.display = selections.length > 0 ? "block" : "none";

  // ▼ 日付ごとにグループ化
  const grouped = {};
  selections.forEach(sel => {
    const d = new Date(sel.date);
    const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const jpDay = ["日","月","火","水","木","金","土"][d.getDay()];
    const label = `${dateKey}（${jpDay}）`;
    if (!grouped[label]) grouped[label] = [];
    grouped[label].push(sel);
  });

  Object.keys(grouped).forEach(dateLabel => {
    const dateGroup = document.createElement("div");
    dateGroup.className = "date-group";
    dateGroup.style.marginTop = "12px";

    const title = document.createElement("div");
    title.textContent = dateLabel;
    title.style.fontWeight = "bold";
    title.style.color = "white";
    title.style.marginBottom = "4px";
    dateGroup.appendChild(title);

    // ▼ その日のスタジオ予約一覧
    grouped[dateLabel].forEach(sel => {
      const div = document.createElement("div");
      div.className = "selection-item";
      div.style.backgroundColor = studioColors[sel.studio];
      div.style.margin = "6px 0";
      div.style.borderRadius = "8px";
      div.style.display = "flex";
      div.style.justifyContent = "space-between";
      div.style.alignItems = "center";
      div.style.padding = "10px 14px";
      div.style.color = "#fff";
      div.style.fontWeight = "bold";

      // ▼ 利用時間とスタジオ名を白字・大きく
      const info = document.createElement("div");
      info.innerHTML = `
        <div style="font-size: 20px; line-height: 1.2;">
          ${sel.time}　
          <span style="font-size: 20px;">${sel.studio}</span>
        </div>
        <div style="font-size: 13px; opacity: 0.8;">
          ¥${studioRates[sel.studio].toLocaleString()}（税込）
        </div>
      `;

      // ▼ 削除ボタン（右端・リンク風）
      const btn = document.createElement("button");
      btn.textContent = "削除";
      btn.style.background = "none";
      btn.style.border = "none";
      btn.style.color = "#fff";
      btn.style.cursor = "pointer";
      btn.style.fontSize = "13px";
      btn.style.textDecoration = "underline";
      btn.onclick = () => removeSelection(sel.date, sel.studio, sel.time);

      div.appendChild(info);
      div.appendChild(btn);
      dateGroup.appendChild(div);
    });

    selectionSummary.appendChild(dateGroup);
  });

  // ▼ 合計金額
  const total = selections.reduce((sum, s) => sum + studioRates[s.studio], 0);
  const totalDiv = document.createElement("div");
  totalDiv.className = "total";
  totalDiv.textContent = `合計：¥${total.toLocaleString()}（税込）`;
  selectionSummary.appendChild(totalDiv);
} // ← renderSelections() の正しい閉じカッコ
                               
window.removeSelection=function(date,studio,time){
  selections=selections.filter(s=>!(s.date===date&&s.studio===studio&&s.time===time));
  renderSelections();
  renderStudios();
};

/* ========== モーダル & 予約確定 ========== */
document.querySelector(".proceed-btn").addEventListener("click",()=>{
  document.getElementById("confirmModal").style.display="flex";
});
document.getElementById("closeModal").addEventListener("click",()=>{
  document.getElementById("confirmModal").style.display="none";
});
document.getElementById("agreeCheck").addEventListener("change",(e)=>{
  document.getElementById("confirmBooking").disabled=!e.target.checked;
});

document.getElementById("confirmBooking").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user){ alert("ログインが必要です。"); return; }
  if(selections.length===0){ alert("予約枠を選択してください。"); return; }

  const invoiceName=document.getElementById("invoiceName").value.trim();
  const remarks=document.getElementById("remarks").value.trim();
  const payment=document.querySelector('input[name="payment"]:checked').value;

  for(const s of selections){
    const id=`${s.studio}_${s.date}_${s.time}`;
    await setDoc(doc(db,"reservations",id),{
      studio:s.studio,
      date:s.date,
      time:s.time,
      user:user.email,
      payment,
      invoiceName,
      remarks,
      createdAt:new Date().toISOString()
    });
  }

  alert("予約が完了しました！");
  document.getElementById("confirmModal").style.display="none";
  selections=[];
  renderSelections();
  renderStudios();
});

window.addEventListener("load",()=>{
  renderCalendar();
  renderStudios();
});
</script>

</body>
</html>
















